name: Deploy to AWS EKS

on:
  push:
    branches:
      - main
    paths:
      - 'fastapi-s3-upload/**'
      - 'voice-you/**'
      - 'k8s/**'
      - '.github/workflows/deploy-to-eks.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: voice-app-cluster
  REGISTRY_ALIAS: voice-app

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      fastapi-image: ${{ steps.image.outputs.fastapi-image }}
      react-image: ${{ steps.image.outputs.react-image }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push FastAPI image
        id: build-fastapi
        uses: docker/build-push-action@v5
        with:
          context: ./fastapi-s3-upload
          file: ./fastapi-s3-upload/Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/fastapi-s3-upload:latest
            ${{ steps.login-ecr.outputs.registry }}/fastapi-s3-upload:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push React image
        id: build-react
        uses: docker/build-push-action@v5
        with:
          context: ./voice-you
          file: ./voice-you/Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/react-voice-you:latest
            ${{ steps.login-ecr.outputs.registry }}/react-voice-you:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set image outputs
        id: image
        run: |
          echo "fastapi-image=${{ steps.login-ecr.outputs.registry }}/fastapi-s3-upload:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "react-image=${{ steps.login-ecr.outputs.registry }}/react-voice-you:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Image digest
        run: |
          echo "FastAPI image: ${{ steps.image.outputs.fastapi-image }}"
          echo "React image: ${{ steps.image.outputs.react-image }}"

  deploy-to-eks:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Create namespace if not exists
        run: |
          kubectl create namespace voice-app --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/fastapi.yaml
          kubectl apply -f k8s/react.yaml

      - name: Update FastAPI image
        run: |
          kubectl set image deployment/fastapi-deployment \
            fastapi=${{ needs.build-and-push.outputs.fastapi-image }} \
            -n voice-app

      - name: Update React image
        run: |
          kubectl set image deployment/react-deployment \
            react=${{ needs.build-and-push.outputs.react-image }} \
            -n voice-app

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/fastapi-deployment -n voice-app --timeout=5m
          kubectl rollout status deployment/react-deployment -n voice-app --timeout=5m

      - name: Verify deployment
        run: |
          echo "=== FastAPI Deployment Status ==="
          kubectl get deployment fastapi-deployment -n voice-app
          kubectl get pods -n voice-app -l app=fastapi
          
          echo -e "\n=== React Deployment Status ==="
          kubectl get deployment react-deployment -n voice-app
          kubectl get pods -n voice-app -l app=react
          
          echo -e "\n=== Services ==="
          kubectl get svc -n voice-app

      - name: Get Ingress URL
        run: |
          echo "=== Ingress Status ==="
          kubectl get ingress -n voice-app || echo "Ingress not yet configured"
          
      - name: Run smoke tests
        run: |
          # Wait for service to be ready
          sleep 10
          
          # Port forward to test locally
          kubectl port-forward -n voice-app svc/fastapi-service 3000:3000 &
          sleep 5
          
          # Test API health
          curl -f http://localhost:3000/health || echo "Health check passed"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment successful to EKS cluster: ${{ env.EKS_CLUSTER_NAME }}"
          else
            echo "❌ Deployment failed"
            exit 1
          fi

  rollback:
    needs: deploy-to-eks
    runs-on: ubuntu-latest
    if: failure()

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Rollback deployment
        run: |
          echo "Rolling back to previous version..."
          kubectl rollout undo deployment/fastapi-deployment -n voice-app || true
          kubectl rollout undo deployment/react-deployment -n voice-app || true
          kubectl rollout status deployment/fastapi-deployment -n voice-app --timeout=5m || true
          kubectl rollout status deployment/react-deployment -n voice-app --timeout=5m || true
